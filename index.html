<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Results Dashboard</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .chart-container {
            width: 80%;
            margin: auto;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Election Results Dashboard</h1>

    <div class="chart-container" id="chart_div"></div>

    <table>
        <thead>
            <tr>
                <th>เขตเลือกตั้ง</th>
                <th>คะแนนนายก อบจ.</th>
                <th>คะแนน สจ.</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            <!-- Data rows will be dynamically inserted here -->
        </tbody>
    </table>

    <script>
        // สร้างการโหลด Google Charts
        google.charts.load('current', {
            packages: ['corechart', 'bar']
        });

        google.charts.setOnLoadCallback(drawChart);

        // ดึงข้อมูลจาก Google Sheets
        const sheetId = '1H-tqTVqLrFPzoiVzoTaSdR7lpk5RVABJmbjA0tXp-SY';
        const apiKey = 'AIzaSyAP8KX0thto04Ok1dFE96IIgtH2J0NeKyU';
        const sheetName = 'Results';
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;

        async function fetchData() {
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!data.values || data.values.length === 0) {
                    console.error("ไม่มีข้อมูลใน Google Sheet หรือ Sheet ว่าง");
                    return;
                }

                displayResults(data.values);
                drawChart(data.values);
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
            }
        }

        function displayResults(data) {
            const resultsBody = document.getElementById("resultsBody");

            // ลบแถวที่มีอยู่ก่อน
            resultsBody.innerHTML = "";

            const rows = data.slice(1); // แถวข้อมูล (ไม่รวม Header)

            rows.forEach(row => {
                const district = row[0]; // เขตเลือกตั้ง
                const mayorScores = row.slice(1, 8); // คะแนนของนายก อบจ. 7 เบอร์
                const councilScores = row.slice(8, 15); // คะแนนของ สจ. 7 เบอร์

                const totalMayorScore = mayorScores.reduce((acc, score) => acc + parseInt(score || 0, 10), 0);
                const totalCouncilScore = councilScores.reduce((acc, score) => acc + parseInt(score || 0, 10), 0);

                const rowElement = document.createElement("tr");
                rowElement.innerHTML = `
                    <td>${district}</td>
                    <td>${totalMayorScore}</td>
                    <td>${totalCouncilScore}</td>
                `;
                resultsBody.appendChild(rowElement);
            });
        }

        // ฟังก์ชันแสดงกราฟ
        function drawChart(data) {
            const rows = data.slice(1); // ข้อมูลจริงจาก Google Sheets (ไม่รวม Header)

            // เตรียมข้อมูลให้ Google Charts
            const chartData = [
                ['เขตเลือกตั้ง', 'คะแนนนายก อบจ.', 'คะแนน สจ.']
            ];

            rows.forEach(row => {
                const district = row[0];
                const mayorScores = row.slice(1, 8);
                const councilScores = row.slice(8, 15);
                const totalMayorScore = mayorScores.reduce((acc, score) => acc + parseInt(score || 0, 10), 0);
                const totalCouncilScore = councilScores.reduce((acc, score) => acc + parseInt(score || 0, 10), 0);

                chartData.push([district, totalMayorScore, totalCouncilScore]);
            });

            // สร้าง Google Chart
            const dataTable = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: 'ผลการเลือกตั้งในแต่ละเขต',
                hAxis: {
                    title: 'เขตเลือกตั้ง',
                    minValue: 0
                },
                vAxis: {
                    title: 'คะแนนรวม'
                },
                bars: 'vertical'
            };
            const chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
            chart.draw(dataTable, options);
        }

        fetchData(); // เรียกใช้ฟังก์ชันดึงข้อมูล
    </script>
</body>
</html>
