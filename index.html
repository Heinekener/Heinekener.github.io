<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Results Dashboard</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            width: 80%;
            margin: auto;
        }
        table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        h2 {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Election Results Dashboard</h1>

        <h2>คะแนนรวม นายก อบจ. (รวมทุกเขต)</h2>
        <table id="mayorTable">
            <thead>
                <tr>
                    <th>เบอร์</th>
                    <th>คะแนน</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>คะแนน สจ. (แยกตามเขต)</h2>
        <div id="councilTables"></div>
    </div>

    <script>
        // Google Sheets API Configuration
        const sheetId = '1H-tqTVqLrFPzoiVzoTaSdR7lpk5RVABJmbjA0tXp-SY';
        const apiKey = 'AIzaSyAP8KX0thto04Ok1dFE96IIgtH2J0NeKyU';
        const sheetName = 'Results';
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}?key=${apiKey}`;

        async function fetchData() {
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!data.values || data.values.length === 0) {
                    console.error("ไม่มีข้อมูลใน Google Sheet หรือ Sheet ว่าง");
                    return;
                }
                processResults(data.values);
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการดึงข้อมูล:", error);
            }
        }

        function processResults(data) {
            const headers = data[0]; // Header Row
            const rows = data.slice(1); // Data Rows

            // แยกข้อมูลสำหรับ นายก อบจ. และ สจ.
            const mayorScores = Array(7).fill(0); // คะแนนรวมของนายก อบจ. (เบอร์ 1-7)
            const councilScoresByDistrict = {}; // คะแนน สจ. แยกตามเขต

            rows.forEach(row => {
                const district = row[0]; // เขตเลือกตั้ง
                const mayorData = row.slice(1, 8); // คะแนนนายก อบจ. (เบอร์ 1-7)
                const councilData = row.slice(8, 15); // คะแนน สจ. (เบอร์ 1-7)

                // รวมคะแนนนายก อบจ.
                mayorData.forEach((score, index) => {
                    mayorScores[index] += parseInt(score || 0, 10);
                });

                // รวมคะแนน สจ. แยกตามเขต
                if (!councilScoresByDistrict[district]) {
                    councilScoresByDistrict[district] = Array(7).fill(0);
                }
                councilData.forEach((score, index) => {
                    councilScoresByDistrict[district][index] += parseInt(score || 0, 10);
                });
            });

            // อัปเดต Dashboard
            updateMayorTable(mayorScores);
            updateCouncilTables(councilScoresByDistrict);
        }

        function updateMayorTable(mayorScores) {
            const mayorTableBody = document.getElementById("mayorTable").querySelector("tbody");
            mayorTableBody.innerHTML = "";

            // จัดรูปแบบข้อมูลและเรียงลำดับคะแนน
            const sortedScores = mayorScores.map((score, index) => ({
                number: index + 1,
                score
            })).sort((a, b) => b.score - a.score);

            sortedScores.forEach(({ number, score }) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${number}</td>
                    <td>${score}</td>
                `;
                mayorTableBody.appendChild(row);
            });
        }

        function updateCouncilTables(councilScoresByDistrict) {
            const councilTablesDiv = document.getElementById("councilTables");
            councilTablesDiv.innerHTML = "";

            Object.keys(councilScoresByDistrict).forEach(district => {
                const scores = councilScoresByDistrict[district];

                // จัดรูปแบบข้อมูลและเรียงลำดับคะแนน
                const sortedScores = scores.map((score, index) => ({
                    number: index + 1,
                    score
                })).sort((a, b) => b.score - a.score);

                // สร้างตารางสำหรับแต่ละเขต
                const table = document.createElement("table");
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th colspan="2">เขตเลือกตั้ง: ${district}</th>
                        </tr>
                        <tr>
                            <th>เบอร์</th>
                            <th>คะแนน</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedScores.map(({ number, score }) => `
                            <tr>
                                <td>${number}</td>
                                <td>${score}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                `;
                councilTablesDiv.appendChild(table);
            });
        }

        // Fetch and display data
        fetchData();
    </script>
</body>
</html>
